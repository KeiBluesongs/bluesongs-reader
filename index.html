<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Aozora Reader (Simple)</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#666; --bar:#f4f4f4; --border:#e5e5e5;
      --fontSize: 18px;
      --lineHeight: 1.9;
      --contentWidth: 42em;
    }
    [data-theme="dark"]{
      --bg:#0f1115; --fg:#eaeef5; --muted:#a9b2c3; --bar:#161a22; --border:#2a3140;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: -apple-system, system-ui, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", sans-serif;
    }

    header{
      position: sticky; top:0; z-index:10;
      background:var(--bar); border-bottom:1px solid var(--border);
      padding:10px max(12px, env(safe-area-inset-left)) 10px max(12px, env(safe-area-inset-right));
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    header .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button, select, input[type="file"]{
      font: inherit;
    }
    button, select{
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--fg);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    button:active{transform: translateY(1px)}
    .hint{color:var(--muted); font-size:12px}

    main{
      height: calc(100% - 0px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 18px 14px 40px 14px;
    }
    .paper{
      margin: 0 auto;
      max-width: var(--contentWidth);
      font-size: var(--fontSize);
      line-height: var(--lineHeight);
      letter-spacing: 0.02em;
      white-space: normal;
      word-break: break-word;
    }
    .title{font-size:1.35em; font-weight:700; margin: 0 0 6px 0;}
    .author{color:var(--muted); margin:0 0 18px 0}
    p{margin: 0 0 0.9em 0;}
    hr{border:none; border-top:1px solid var(--border); margin: 18px 0;}
    ruby rt{font-size:0.6em; color:var(--muted)}
    .empty{
      color:var(--muted);
      border:1px dashed var(--border);
      border-radius:14px;
      padding:18px;
    }

    /* ç¸¦æ›¸ã */
    [data-writing="vertical"] .paper{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      max-width: none;
      width: min(92vw, 46em);
      margin: 0 auto;
    }
    [data-writing="vertical"] p{margin: 0 0 1.2em 0;}
  </style>
</head>
<body data-theme="light" data-writing="horizontal">
  <header>
    <div class="group">
      <input id="file" type="file" accept=".txt,.text,.html,.htm" />
      <select id="encoding">
        <option value="utf-8">UTF-8</option>
        <option value="shift_jis">Shift_JIS</option>
      </select>
      <span class="hint">é’ç©ºæ–‡åº«txtã¯Shift_JISãŒå¤šã„</span>
    </div>

    <div class="group">
      <button id="smaller">A-</button>
      <button id="bigger">A+</button>
      <button id="lhDown">è¡Œé–“-</button>
      <button id="lhUp">è¡Œé–“+</button>
      <button id="theme">ğŸŒ™/â˜€ï¸</button>
      <button id="writing">ç¸¦/æ¨ª</button>
      <button id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <main id="scroller">
    <div class="paper" id="paper">
      <div class="empty">
        <div style="font-weight:700; margin-bottom:6px;">Aozora Reader</div>
        <div>ä¸Šã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã€ã‹ã‚‰é’ç©ºæ–‡åº«ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ.txtï¼‰ã‚’é¸ã¶ã¨ã€ãƒ«ãƒ“ã‚’å†ç¾ã—ã¦èª­ã‚ã‚‹ã‚ˆã€‚</div>
        <div style="margin-top:10px;" class="hint">ãƒ«ãƒ“è¨˜æ³•ä¾‹ï¼šï½œæ¼¢å­—ã€Šã‹ã‚“ã˜ã€‹</div>
      </div>
    </div>
  </main>

<script>
(() => {
  const el = (id) => document.getElementById(id);
  const fileInput = el("file");
  const encodingSel = el("encoding");
  const paper = el("paper");
  const scroller = el("scroller");

  const settingsKey = "aozora_reader_settings_v1";
  const state = {
    theme: "light",
    writing: "horizontal",
    fontSize: 18,
    lineHeight: 1.9,
    lastDocId: null,
    lastScrollRatio: 0
  };

  // ---- utils
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function setCssVars(){
    document.documentElement.style.setProperty("--fontSize", state.fontSize + "px");
    document.documentElement.style.setProperty("--lineHeight", state.lineHeight);
  }
  function applyTheme(){
    document.body.dataset.theme = state.theme;
  }
  function applyWriting(){
    document.body.dataset.writing = state.writing;
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(settingsKey);
      if(!raw) return;
      const x = JSON.parse(raw);
      Object.assign(state, x);
    }catch(e){}
  }
  function saveSettings(){
    localStorage.setItem(settingsKey, JSON.stringify({
      theme: state.theme,
      writing: state.writing,
      fontSize: state.fontSize,
      lineHeight: state.lineHeight,
      lastDocId: state.lastDocId,
      lastScrollRatio: state.lastScrollRatio
    }));
  }

  // ---- Aozora txt -> HTML (æœ€ä½é™)
  function stripAozoraHeader(text){
    // é’ç©ºtxtã¯ã‚¿ã‚¤ãƒˆãƒ«/è‘—è€…/æ³¨æ„æ›¸ã + ç½«ç·šã§åŒºåˆ‡ã‚‰ã‚Œã¦æœ¬æ–‡ã€ãŒå¤šã„
    const lines = text.replace(/\r\n/g,"\n").split("\n");
    const ruleIdx = [];
    for(let i=0;i<lines.length;i++){
      if(/^[-ãƒ¼]{10,}$/.test(lines[i].trim())) ruleIdx.push(i);
      if(ruleIdx.length>=2) break;
    }
    if(ruleIdx.length>=2){
      return lines.slice(ruleIdx[1]+1).join("\n");
    }
    return text;
  }

  function aozoraToHtml(txt){
    let t = txt;
    t = stripAozoraHeader(t);

    // ã¾ãšHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    t = escapeHtml(t);

    // ä»£è¡¨çš„ãªæ³¨è¨˜ï¼ˆâ€»ï¼»ï¼ƒ...ï¼½ï¼‰ã¯æ¶ˆã™ï¼ˆå®Œå…¨å¯¾å¿œã¯å¤§å¤‰ãªã®ã§MVPã¯å‰²ã‚Šåˆ‡ã‚Šï¼‰
    t = t.replace(/â€»ï¼»ï¼ƒ[^ï¼½]*ï¼½/g, "");
    t = t.replace(/ï¼»ï¼ƒ[^ï¼½]*ï¼½/g, "");

    // å¼·èª¿ï¼ˆã€Šã€Šå¼·èª¿ã€‹ã€‹ï¼‰ã‚’å¤ªå­—ã«ï¼ˆç°¡æ˜“ï¼‰
    t = t.replace(/ã€Šã€Š(.+?)ã€‹ã€‹/g, "<strong>$1</strong>");

    // ãƒ«ãƒ“ï¼šï½œåŸºåº•ã€Šãƒ«ãƒ“ã€‹
    t = t.replace(/ï½œ([^ã€Š\n]+)ã€Š([^ã€‹\n]+)ã€‹/g,
      `<ruby><rb>$1</rb><rt>$2</rt></ruby>`);

    // ãƒ«ãƒ“ï¼ˆãƒãƒ¼ç„¡ã—ï¼‰ã®ç°¡æ˜“å¯¾å¿œï¼šæ¼¢å­—åˆ—ã€Šã‚ˆã¿ã€‹
    // â€»èª¤å¤‰æ›ã®å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§æ§ãˆã‚ã«ï¼šæ¼¢å­—ã£ã½ã„é€£ç¶šã ã‘
    t = t.replace(/([ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]{1,20})ã€Š([^ã€‹\n]+)ã€‹/g,
      `<ruby><rb>$1</rb><rt>$2</rt></ruby>`);

    // æ®µè½åŒ–ï¼šç©ºè¡Œã§åŒºåˆ‡ã‚‹
    const blocks = t.split(/\n{2,}/).map(b => b.trim()).filter(Boolean);
    const html = blocks.map(b => `<p>${b.replace(/\n/g,"<br>")}</p>`).join("\n");
    return html;
  }

  function readFileAsText(file, encoding){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(fr.error);
      fr.onload = () => resolve(fr.result);
      try{
        fr.readAsText(file, encoding);
      }catch(e){
        // encodingæŒ‡å®šãŒåŠ¹ã‹ãªã„ç’°å¢ƒå‘ã‘
        fr.readAsText(file);
      }
    });
  }

  function docIdFromFile(file){
    return `${file.name}__${file.size}__${file.lastModified}`;
  }

  async function openFile(file){
    const enc = encodingSel.value;
    const text = await readFileAsText(file, enc);

    const id = docIdFromFile(file);
    state.lastDocId = id;

    // ã‚¿ã‚¤ãƒˆãƒ«æ¨å®šï¼ˆæœ€åˆã®æ•°è¡Œã‹ã‚‰æ‹¾ã†ï¼šMVPï¼‰
    const headLines = String(text).replace(/\r\n/g,"\n").split("\n").slice(0,20).map(s=>s.trim()).filter(Boolean);
    const title = headLines[0] || file.name;
    const author = headLines[1] && headLines[1] !== title ? headLines[1] : "";

    const body = aozoraToHtml(String(text));
    paper.innerHTML = `
      <div class="title">${escapeHtml(title)}</div>
      ${author ? `<div class="author">${escapeHtml(author)}</div>` : ""}
      <hr/>
      ${body}
    `;

    // å‰å›ä½ç½®ã¸å¾©å¸°
    const posKey = "aozora_reader_pos_" + id;
    const raw = localStorage.getItem(posKey);
    if(raw){
      const ratio = parseFloat(raw);
      if(!Number.isNaN(ratio)){
        requestAnimationFrame(() => {
          const max = scroller.scrollHeight - scroller.clientHeight;
          scroller.scrollTop = Math.floor(max * clamp(ratio, 0, 1));
        });
      }
    } else {
      scroller.scrollTop = 0;
    }
    saveSettings();
  }

  // ---- controls
  el("smaller").onclick = () => { state.fontSize = clamp(state.fontSize - 1, 14, 30); setCssVars(); saveSettings(); };
  el("bigger").onclick  = () => { state.fontSize = clamp(state.fontSize + 1, 14, 30); setCssVars(); saveSettings(); };
  el("lhDown").onclick  = () => { state.lineHeight = clamp((state.lineHeight - 0.1), 1.2, 2.6).toFixed(2); setCssVars(); saveSettings(); };
  el("lhUp").onclick    = () => { state.lineHeight = clamp((parseFloat(state.lineHeight) + 0.1), 1.2, 2.6).toFixed(2); setCssVars(); saveSettings(); };

  el("theme").onclick = () => {
    state.theme = (state.theme === "light") ? "dark" : "light";
    applyTheme(); saveSettings();
  };
  el("writing").onclick = () => {
    state.writing = (state.writing === "horizontal") ? "vertical" : "horizontal";
    applyWriting(); saveSettings();
  };
  el("reset").onclick = () => {
    state.theme = "light"; state.writing = "horizontal"; state.fontSize = 18; state.lineHeight = 1.9;
    applyTheme(); applyWriting(); setCssVars(); saveSettings();
  };

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      await openFile(file);
    }catch(err){
      paper.innerHTML = `<div class="empty">
        <div style="font-weight:700;margin-bottom:6px;">èª­ã¿è¾¼ã¿å¤±æ•—</div>
        <div class="hint">Shift_JISãŒèª­ã‚ãªã„ç’°å¢ƒã‹ã‚‚ã€‚æ¬¡ã‚’è©¦ã—ã¦ã­ï¼šâ‘ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’UTF-8ã«ã—ã¦å†æŒ‘æˆ¦ â‘¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’UTF-8ã¸å¤‰æ›ã—ã¦ã‹ã‚‰èª­ã¿è¾¼ã¿</div>
        <div class="hint" style="margin-top:10px;">è©³ç´°: ${escapeHtml(String(err))}</div>
      </div>`;
    }
  });

  // èª­æ›¸ä½ç½®ä¿å­˜ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¯”ï¼‰
  scroller.addEventListener("scroll", () => {
    if(!state.lastDocId) return;
    const max = scroller.scrollHeight - scroller.clientHeight;
    const ratio = max > 0 ? (scroller.scrollTop / max) : 0;
    const posKey = "aozora_reader_pos_" + state.lastDocId;
    localStorage.setItem(posKey, String(clamp(ratio, 0, 1)));
    state.lastScrollRatio = ratio;
    saveSettings();
  }, { passive:true });

  // init
  loadSettings();
  applyTheme();
  applyWriting();
  setCssVars();
})();
</script>
</body>
</html>