<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bluesongs Reader</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#666; --bar:#f4f4f4; --border:#e5e5e5;
      --fontSize: 18px;
      --lineHeight: 1.9;
      --contentWidth: 42em;
      --fontFamily: -apple-system, system-ui, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Noto Sans JP", sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0f1115; --fg:#eaeef5; --muted:#a9b2c3; --bar:#161a22; --border:#2a3140;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: var(--fontFamily);
    }

    /* æŠ˜ã‚ŠãŸãŸã¿è¨­å®šãƒãƒ¼ */
    details#controls{
      position: sticky; top:0; z-index:10;
      background:var(--bar);
      border-bottom:1px solid var(--border);
    }
    details#controls > summary{
      list-style:none;
      cursor:pointer;
      padding:10px max(12px, env(safe-area-inset-left)) 10px max(12px, env(safe-area-inset-right));
      display:flex; gap:10px; align-items:center;
      user-select:none;
    }
    details#controls > summary::-webkit-details-marker{ display:none; }
    .summaryTitle{ font-weight:700; white-space:nowrap; }
    .summaryNow{
      color:var(--muted); font-size:12px; flex:1;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .summaryHint{ color:var(--muted); font-size:12px; white-space:nowrap; }

    .controlsInner{
      padding: 0 max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button, select, input[type="file"]{ font: inherit; }
    button, select{
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--fg);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
    }
    button:active{transform: translateY(1px)}
    .hint{color:var(--muted); font-size:12px}

    /* æœ¬æ–‡é ˜åŸŸ */
    main{
      height: calc(100% - 0px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 18px 14px 40px 14px;
      overscroll-behavior: contain;
    }
    .paper{
      margin: 0 auto;
      max-width: var(--contentWidth);
      font-size: var(--fontSize);
      line-height: var(--lineHeight);
      letter-spacing: 0.02em;
      white-space: normal;
      word-break: break-word;
    }
    .title{font-size:1.35em; font-weight:700; margin: 0 0 6px 0;}
    .author{color:var(--muted); margin:0 0 18px 0}
    p{margin: 0 0 0.9em 0;}
    hr{border:none; border-top:1px solid var(--border); margin: 18px 0;}
    ruby rt{font-size:0.6em; color:var(--muted)}
    .empty{
      color:var(--muted);
      border:1px dashed var(--border);
      border-radius:14px;
      padding:18px;
    }

    /* ç¸¦æ›¸ãï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§åˆ—é€ã‚Š */
    [data-writing="vertical"] main{
      overflow-x: auto;
      overflow-y: hidden;
      padding: 18px 10px 24px 10px;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
    }
    [data-writing="vertical"] .paper{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      height: calc(100vh - 64px); /* JSã§å¾®èª¿æ•´ */
      width: max-content;
      max-width: none;
      margin: 0;
      padding-inline: 10px;
    }
    [data-writing="vertical"] .paper > *{
      scroll-snap-align: start;
    }
    [data-writing="vertical"] p{margin: 0 0 1.2em 0;}

    /* ãƒšãƒ¼ã‚¸è¡¨ç¤ºHUDï¼ˆå¸¸ã«æ§ãˆã‚ã«è¡¨ç¤ºï¼‰ */
    #pageHud{
      position: fixed;
      right: max(10px, env(safe-area-inset-right));
      bottom: max(10px, env(safe-area-inset-bottom));
      z-index: 30;
      background: color-mix(in srgb, var(--bg) 82%, transparent);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--muted);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select:none;
      cursor:pointer;
      opacity: 0.85;
    }
    #pageHud strong{ color: var(--fg); font-weight:700; }

    /* ã‚¹ã‚¯ãƒ©ãƒãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã ã‘è¡¨ç¤ºï¼‰ */
    #scrubberWrap{
      position: fixed;
      left: max(12px, env(safe-area-inset-left));
      right: max(12px, env(safe-area-inset-right));
      bottom: calc(max(10px, env(safe-area-inset-bottom)) + 40px);
      z-index: 29;
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
    }
    #scrubberTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      font-size:12px;
      color:var(--muted);
    }
    #scrubberTop strong{ color:var(--fg); }
    #scrubber{
      width: 100%;
      accent-color: currentColor;
    }
    #jumpRow{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:8px;
    }
    #jumpRow button{
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
    }
  </style>
</head>
<body data-theme="light" data-writing="horizontal">
  <details id="controls">
    <summary>
      <span class="summaryTitle">âš™ï¸ è¨­å®š</span>
      <span class="summaryNow" id="nowReading">æœªèª­</span>
      <span class="summaryHint" id="openHint">â–¼</span>
    </summary>

    <div class="controlsInner">
      <div class="group">
        <input id="file" type="file" accept=".txt,.text,.html,.htm" />
        <select id="encoding" title="æ–‡å­—ã‚³ãƒ¼ãƒ‰">
          <option value="shift-jis">Shift_JIS</option>
          <option value="utf-8">UTF-8</option>
        </select>

        <select id="font" title="ãƒ•ã‚©ãƒ³ãƒˆ">
          <option value="mincho">æ˜æœï¼ˆãŠã™ã™ã‚ï¼‰</option>
          <option value="gothic">ã‚´ã‚·ãƒƒã‚¯</option>
          <option value="serif">Serifï¼ˆæ±ç”¨ï¼‰</option>
        </select>

        <span class="hint">é’ç©ºæ–‡åº«txtã¯Shift_JISãŒå¤šã„</span>
      </div>

      <div class="group">
        <button id="smaller">A-</button>
        <button id="bigger">A+</button>
        <button id="lhDown">è¡Œé–“-</button>
        <button id="lhUp">è¡Œé–“+</button>
        <button id="theme">ğŸŒ™/â˜€ï¸</button>
        <button id="writing">ç¸¦/æ¨ª</button>
        <button id="resetView">è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ</button>
        <button id="resetLoad" title="èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢">èª­ã¿è¾¼ã¿ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </details>

  <main id="scroller">
    <div class="paper" id="paper">
      <div class="empty">
        <div style="font-weight:700; margin-bottom:6px;">Bluesongs Reader</div>
        <div>ã€Œè¨­å®šã€â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨ã€é’ç©ºæ–‡åº«ã®ãƒ«ãƒ“ä»˜ããƒ†ã‚­ã‚¹ãƒˆã‚’èª­æ›¸ã‚¢ãƒ—ãƒªã£ã½ãèª­ã‚ã‚‹ã‚ˆã€‚</div>
        <div style="margin-top:10px;" class="hint">ãƒ«ãƒ“è¨˜æ³•ä¾‹ï¼šï½œæ¼¢å­—ã€Šã‹ã‚“ã˜ã€‹</div>
      </div>
    </div>
  </main>

  <!-- ãƒšãƒ¼ã‚¸HUD & ã‚¹ã‚¯ãƒ©ãƒãƒ¼ -->
  <div id="pageHud" title="ã‚¿ãƒƒãƒ—ã§ãƒšãƒ¼ã‚¸ç§»å‹•ãƒãƒ¼">
    <strong id="pageNow">-</strong> / <span id="pageTotal">-</span>
  </div>
  <div id="scrubberWrap" aria-hidden="true">
    <div id="scrubberTop">
      <div>ãƒšãƒ¼ã‚¸ <strong id="scrubberNow">-</strong> / <span id="scrubberTotal">-</span></div>
      <div id="modeLabel">æ¨ªæ›¸ã</div>
    </div>
    <input id="scrubber" type="range" min="1" max="1" value="1" step="1" />
    <div id="jumpRow">
      <button id="jumpStart" type="button">å…ˆé ­</button>
      <button id="jumpEnd" type="button">æœ«å°¾</button>
      <button id="scrubberClose" type="button">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const controls = el("controls");
  const nowReading = el("nowReading");
  const openHint = el("openHint");

  const fileInput = el("file");
  const encodingSel = el("encoding");
  const fontSel = el("font");

  const paper = el("paper");
  const scroller = el("scroller");

  const pageHud = el("pageHud");
  const pageNowEl = el("pageNow");
  const pageTotalEl = el("pageTotal");

  const scrubberWrap = el("scrubberWrap");
  const scrubber = el("scrubber");
  const scrubberNowEl = el("scrubberNow");
  const scrubberTotalEl = el("scrubberTotal");
  const modeLabel = el("modeLabel");
  const scrubberClose = el("scrubberClose");
  const jumpStart = el("jumpStart");
  const jumpEnd = el("jumpEnd");

  const settingsKey = "bluesongs_reader_settings_v4";

  // èª­ã¿è¾¼ã¿æ¸ˆã¿ã®ãƒã‚¤ãƒˆåˆ—ï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã§å†ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼‰
  let lastFileBuf = null;     // ArrayBuffer
  let lastFileMeta = null;    // {name,size,lastModified}
  let lastDocId = null;
  let lastTitle = null;

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆç¸¦æ›¸ãï¼‰
  let vTotalPages = 1;
  let vCurrentPage = 1;
  let hideScrubberTimer = null;
  let ignoreScrollOnce = false;

  const state = {
    theme: "light",
    writing: "horizontal",
    fontSize: 18,
    lineHeight: 1.9,
    encoding: "shift-jis",
    font: "mincho"
  };

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function setCssVars(){
    document.documentElement.style.setProperty("--fontSize", state.fontSize + "px");
    document.documentElement.style.setProperty("--lineHeight", state.lineHeight);

    const stacks = {
      mincho: `"Hiragino Mincho ProN","YuMincho","Noto Serif JP","Hiragino Mincho Pro",serif`,
      gothic: `-apple-system, system-ui, "Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif`,
      serif: `ui-serif, "Times New Roman", Times, serif`
    };
    document.documentElement.style.setProperty("--fontFamily", stacks[state.font] || stacks.mincho);
  }
  function applyTheme(){ document.body.dataset.theme = state.theme; }

  function updateOpenHint(){
    openHint.textContent = controls.open ? "â–²" : "â–¼";
  }

  function saveSettings(){
    localStorage.setItem(settingsKey, JSON.stringify({
      theme: state.theme,
      writing: state.writing,
      fontSize: state.fontSize,
      lineHeight: state.lineHeight,
      encoding: state.encoding,
      font: state.font,
      lastDocId,
      lastTitle
    }));
  }
  function loadSettings(){
    try{
      const raw = localStorage.getItem(settingsKey);
      if(!raw) return;
      const x = JSON.parse(raw);
      Object.assign(state, x);
      if(x.lastDocId) lastDocId = x.lastDocId;
      if(x.lastTitle) lastTitle = x.lastTitle;
    }catch(e){}
  }

  function refreshNowReading(){
    nowReading.textContent = lastTitle ? lastTitle : "æœªèª­";
  }

  // ---- Aozora txt -> HTML
  function stripAozoraHeader(text){
    const lines = text.replace(/\r\n/g,"\n").split("\n");
    const ruleIdx = [];
    for(let i=0;i<lines.length;i++){
      if(/^[-ãƒ¼]{10,}$/.test(lines[i].trim())) ruleIdx.push(i);
      if(ruleIdx.length>=2) break;
    }
    if(ruleIdx.length>=2){
      return lines.slice(ruleIdx[1]+1).join("\n");
    }
    return text;
  }

  function aozoraToHtml(txt){
    let t = stripAozoraHeader(txt);
    t = escapeHtml(t);

    t = t.replace(/â€»ï¼»ï¼ƒ[^ï¼½]*ï¼½/g, "");
    t = t.replace(/ï¼»ï¼ƒ[^ï¼½]*ï¼½/g, "");
    t = t.replace(/ã€Šã€Š(.+?)ã€‹ã€‹/g, "<strong>$1</strong>");
    t = t.replace(/ï½œ([^ã€Š\n]+)ã€Š([^ã€‹\n]+)ã€‹/g, `<ruby><rb>$1</rb><rt>$2</rt></ruby>`);
    t = t.replace(/([ä¸€-é¾¥ã€…ã€†ãƒµãƒ¶]{1,20})ã€Š([^ã€‹\n]+)ã€‹/g, `<ruby><rb>$1</rb><rt>$2</rt></ruby>`);

    const blocks = t.split(/\n{2,}/).map(b => b.trim()).filter(Boolean);
    return blocks.map(b => `<p>${b.replace(/\n/g,"<br>")}</p>`).join("\n");
  }

  function docIdFromMeta(meta){
    return `${meta.name}__${meta.size}__${meta.lastModified}`;
  }

  function decodeFromBuffer(buf, encoding){
    const dec = new TextDecoder(encoding);
    return dec.decode(buf);
  }

  function renderText(text){
    const headLines = String(text).replace(/\r\n/g,"\n").split("\n").slice(0,20).map(s=>s.trim()).filter(Boolean);
    const title = headLines[0] || (lastFileMeta?.name ?? "Untitled");
    const author = headLines[1] && headLines[1] !== title ? headLines[1] : "";

    lastTitle = title;
    refreshNowReading();

    const body = aozoraToHtml(String(text));
    paper.innerHTML = `
      <div class="title">${escapeHtml(title)}</div>
      ${author ? `<div class="author">${escapeHtml(author)}</div>` : ""}
      <hr/>
      ${body}
    `;
  }

  function showError(err){
    paper.innerHTML = `<div class="empty">
      <div style="font-weight:700;margin-bottom:6px;">èª­ã¿è¾¼ã¿å¤±æ•—</div>
      <div class="hint">â‘ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚ã†ä¸€åº¦ï¼ˆShift_JIS / UTF-8ï¼‰</div>
      <div class="hint">â‘¡ã€Œèª­ã¿è¾¼ã¿ãƒªã‚»ãƒƒãƒˆã€â†’ãƒ•ã‚¡ã‚¤ãƒ«é¸ã³ç›´ã—</div>
      <div class="hint" style="margin-top:10px;">è©³ç´°: ${escapeHtml(String(err))}</div>
    </div>`;
  }

  // ---- ãƒšãƒ¼ã‚¸è¨ˆç®—ï¼ˆæ¨ªæ›¸ãï¼ç¸¦æ›¸ã å…±é€šHUDï¼‰
  function calcHorizontalProgress(){
    // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¯”ã‚’ â€œãƒšãƒ¼ã‚¸ã£ã½ãâ€ ã«è¡¨ç¤ºï¼ˆ100åˆ†å‰²ï¼‰
    const max = scroller.scrollHeight - scroller.clientHeight;
    const ratio = max > 0 ? (scroller.scrollTop / max) : 0;
    const total = 100;
    const now = clamp(Math.round(ratio * (total - 1)) + 1, 1, total);
    return { now, total };
  }

  function calcVerticalPages(){
    const max = Math.max(0, scroller.scrollWidth - scroller.clientWidth);
    const pageW = Math.max(1, scroller.clientWidth);
    const total = Math.max(1, Math.floor(max / pageW) + 1);

    // â˜…ç¸¦æ›¸ã( vertical-rl )ã¯ã€å³ç«¯ãŒå…ˆé ­ã«ãªã‚Šã‚„ã™ã„ï¼ˆiOS/Safariï¼‰
    // å…ˆé ­ã‚’ã€Œmaxã€ã€é€²ã‚€ã»ã© scrollLeft ãŒå°ã•ããªã‚‹æƒ³å®šã§ãƒšãƒ¼ã‚¸è¨ˆç®—
    const progress = clamp(max - scroller.scrollLeft, 0, max);
    const now = clamp(Math.floor(progress / pageW) + 1, 1, total);
    return { now, total, max, pageW };
  }

  function updateHudAndScrubber(){
    if(document.body.dataset.writing === "vertical"){
      const { now, total } = calcVerticalPages();
      vCurrentPage = now;
      vTotalPages = total;
      pageNowEl.textContent = String(now);
      pageTotalEl.textContent = String(total);

      scrubber.max = String(total);
      scrubber.value = String(now);
      scrubberNowEl.textContent = String(now);
      scrubberTotalEl.textContent = String(total);
      modeLabel.textContent = "ç¸¦æ›¸ã";
    } else {
      const { now, total } = calcHorizontalProgress();
      pageNowEl.textContent = String(now);
      pageTotalEl.textContent = String(total);

      scrubber.max = String(total);
      scrubber.value = String(now);
      scrubberNowEl.textContent = String(now);
      scrubberTotalEl.textContent = String(total);
      modeLabel.textContent = "æ¨ªæ›¸ã";
    }
  }

  function showScrubberTemporarily(){
    scrubberWrap.style.display = "block";
    scrubberWrap.setAttribute("aria-hidden", "false");
    if(hideScrubberTimer) clearTimeout(hideScrubberTimer);
    hideScrubberTimer = setTimeout(() => {
      scrubberWrap.style.display = "none";
      scrubberWrap.setAttribute("aria-hidden", "true");
    }, 1200);
  }

  function hideScrubber(){
    if(hideScrubberTimer) clearTimeout(hideScrubberTimer);
    scrubberWrap.style.display = "none";
    scrubberWrap.setAttribute("aria-hidden", "true");
  }

  function gotoVerticalPage(page){
    const { total, max, pageW } = calcVerticalPages();
    const p = clamp(page, 1, total);
    // å³ç«¯=å…ˆé ­ï¼ˆmaxï¼‰â†’ é€²ã‚€ã»ã©å·¦ã¸ï¼ˆscrollLeftãŒæ¸›ã‚‹ï¼‰
    const target = clamp(max - (p - 1) * pageW, 0, max);
    ignoreScrollOnce = true;
    scroller.scrollLeft = target;
    requestAnimationFrame(() => { ignoreScrollOnce = false; });
  }

  function gotoHorizontalPercentPage(page){
    const total = 100;
    const p = clamp(page, 1, total);
    const max = Math.max(0, scroller.scrollHeight - scroller.clientHeight);
    const ratio = (p - 1) / (total - 1);
    ignoreScrollOnce = true;
    scroller.scrollTop = Math.floor(max * ratio);
    requestAnimationFrame(() => { ignoreScrollOnce = false; });
  }

  // ---- ç¸¦æ›¸ãã€Œå…ˆé ­ãŒæœ€çµ‚ãƒšãƒ¼ã‚¸ã«ãªã‚‹ã€å¯¾ç­–
  function setVerticalToStart(){
    const max = Math.max(0, scroller.scrollWidth - scroller.clientWidth);
    // â˜…iOS/Safariã¯ç¸¦æ›¸ãã§å³ç«¯ãŒå…ˆé ­ã«ãªã‚ŠãŒã¡ãªã®ã§ max ã«åˆã‚ã›ã‚‹
    ignoreScrollOnce = true;
    scroller.scrollLeft = max;
    requestAnimationFrame(() => { ignoreScrollOnce = false; updateHudAndScrubber(); });
  }

  function applyWriting(){
    document.body.dataset.writing = state.writing;

    if(state.writing === "vertical"){
      requestAnimationFrame(() => {
        const controlsH = controls.getBoundingClientRect().height;
        const pad = 18;
        const h = Math.max(240, window.innerHeight - controlsH - pad);
        paper.style.height = h + "px";

        // â˜…åˆ‡ã‚Šæ›¿ãˆç›´å¾Œã«ã€Œæœ€çµ‚ãƒšãƒ¼ã‚¸ã¸é£›ã¶ã€ç—‡çŠ¶ã‚’æŠ‘æ­¢ï¼šæç”»ãŒè½ã¡ç€ã„ãŸã‚‰å¿…ãšå…ˆé ­ã¸
        setTimeout(() => setVerticalToStart(), 0);
      });
    } else {
      paper.style.height = "";
    }
    updateHudAndScrubber();
  }

  async function openFile(file){
    lastFileBuf = await file.arrayBuffer();
    lastFileMeta = { name:file.name, size:file.size, lastModified:file.lastModified };
    lastDocId = docIdFromMeta(lastFileMeta);

    try{
      const text = decodeFromBuffer(lastFileBuf, encodingSel.value);
      renderText(text);
    }catch(err){
      showError(err);
      return;
    }

    // ä½ç½®å¾©å¸°
    if(document.body.dataset.writing !== "vertical"){
      const posKey = "bluesongs_reader_pos_" + lastDocId;
      const raw = localStorage.getItem(posKey);
      requestAnimationFrame(() => {
        if(raw){
          const ratio = parseFloat(raw);
          if(!Number.isNaN(ratio)){
            const max = scroller.scrollHeight - scroller.clientHeight;
            scroller.scrollTop = Math.floor(max * clamp(ratio, 0, 1));
          } else {
            scroller.scrollTop = 0;
          }
        } else {
          scroller.scrollTop = 0;
        }
        updateHudAndScrubber();
      });
    } else {
      // ç¸¦æ›¸ãã¯ã€Œå…ˆé ­ï¼ˆå³ç«¯ï¼‰ã€ã¸
      requestAnimationFrame(() => setVerticalToStart());
      // ç¸¦æ›¸ãä½ç½®ã‚’ä¿å­˜ã—ã¦ã„ãŸã‚‰å¾©å¸°
      const vKey = "bluesongs_reader_vpage_" + lastDocId;
      const saved = localStorage.getItem(vKey);
      if(saved){
        const p = parseInt(saved, 10);
        if(!Number.isNaN(p)){
          requestAnimationFrame(() => gotoVerticalPage(p));
        }
      }
    }

    saveSettings();

    controls.open = false;
    updateOpenHint();
  }

  function rerenderWithCurrentEncoding(){
    if(!lastFileBuf) return;
    try{
      const text = decodeFromBuffer(lastFileBuf, encodingSel.value);
      renderText(text);
      if(document.body.dataset.writing === "vertical"){
        setVerticalToStart();
      } else {
        scroller.scrollTop = 0;
      }
      saveSettings();
      updateHudAndScrubber();
    }catch(err){
      showError(err);
    }
  }

  function resetLoad(){
    lastFileBuf = null;
    lastFileMeta = null;
    lastDocId = null;
    lastTitle = null;
    refreshNowReading();
    fileInput.value = "";
    scroller.scrollTop = 0;
    scroller.scrollLeft = 0;

    paper.innerHTML = `
      <div class="empty">
        <div style="font-weight:700; margin-bottom:6px;">Bluesongs Reader</div>
        <div>ã€Œè¨­å®šã€â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨ã€é’ç©ºæ–‡åº«ã®ãƒ«ãƒ“ä»˜ããƒ†ã‚­ã‚¹ãƒˆã‚’èª­æ›¸ã‚¢ãƒ—ãƒªã£ã½ãèª­ã‚ã‚‹ã‚ˆã€‚</div>
        <div style="margin-top:10px;" class="hint">ãƒ«ãƒ“è¨˜æ³•ä¾‹ï¼šï½œæ¼¢å­—ã€Šã‹ã‚“ã˜ã€‹</div>
      </div>
    `;
    updateHudAndScrubber();
    saveSettings();
  }

  // ---- controls
  el("smaller").onclick = () => { state.fontSize = clamp(state.fontSize - 1, 14, 30); setCssVars(); saveSettings(); applyWriting(); };
  el("bigger").onclick  = () => { state.fontSize = clamp(state.fontSize + 1, 14, 30); setCssVars(); saveSettings(); applyWriting(); };

  el("lhDown").onclick  = () => { state.lineHeight = clamp((parseFloat(state.lineHeight) - 0.1), 1.2, 2.6).toFixed(2); setCssVars(); saveSettings(); applyWriting(); };
  el("lhUp").onclick    = () => { state.lineHeight = clamp((parseFloat(state.lineHeight) + 0.1), 1.2, 2.6).toFixed(2); setCssVars(); saveSettings(); applyWriting(); };

  el("theme").onclick = () => {
    state.theme = (state.theme === "light") ? "dark" : "light";
    applyTheme(); saveSettings();
  };
  el("writing").onclick = () => {
    state.writing = (state.writing === "horizontal") ? "vertical" : "horizontal";
    applyWriting(); saveSettings();

    // è¦‹å¤±ã„é˜²æ­¢
    if(state.writing === "vertical"){
      setVerticalToStart();
    } else {
      scroller.scrollTop = 0;
    }
  };

  el("resetView").onclick = () => {
    state.theme = "light";
    state.writing = "horizontal";
    state.fontSize = 18;
    state.lineHeight = 1.9;
    state.font = "mincho";
    applyTheme();
    setCssVars();
    fontSel.value = state.font;
    applyWriting();
    saveSettings();
  };

  el("resetLoad").onclick = () => resetLoad();

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    await openFile(file);
  });

  encodingSel.addEventListener("change", () => {
    state.encoding = encodingSel.value;
    saveSettings();
    rerenderWithCurrentEncoding();
  });

  fontSel.addEventListener("change", () => {
    state.font = fontSel.value;
    setCssVars();
    saveSettings();
    applyWriting();
  });

  // ---- HUD / Scrubber
  pageHud.addEventListener("click", () => {
    // ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰
    const showing = scrubberWrap.style.display === "block";
    if(showing) hideScrubber();
    else {
      updateHudAndScrubber();
      scrubberWrap.style.display = "block";
      scrubberWrap.setAttribute("aria-hidden", "false");
    }
  });

  scrubber.addEventListener("input", () => {
    const val = parseInt(scrubber.value, 10);
    scrubberNowEl.textContent = String(val);
    if(document.body.dataset.writing === "vertical"){
      gotoVerticalPage(val);
    } else {
      gotoHorizontalPercentPage(val);
    }
  });

  scrubberClose.addEventListener("click", () => hideScrubber());
  jumpStart.addEventListener("click", () => {
    if(document.body.dataset.writing === "vertical") gotoVerticalPage(1);
    else gotoHorizontalPercentPage(1);
    updateHudAndScrubber();
  });
  jumpEnd.addEventListener("click", () => {
    if(document.body.dataset.writing === "vertical") gotoVerticalPage(vTotalPages);
    else gotoHorizontalPercentPage(100);
    updateHudAndScrubber();
  });

  // ---- scroll behavior
  scroller.addEventListener("scroll", () => {
    if(ignoreScrollOnce) return;
    updateHudAndScrubber();
    showScrubberTemporarily();

    // ä½ç½®ä¿å­˜ï¼šæ¨ªæ›¸ãã¯æ¯”ç‡ã€ç¸¦æ›¸ãã¯ãƒšãƒ¼ã‚¸ç•ªå·
    if(!lastDocId) return;

    if(document.body.dataset.writing === "vertical"){
      const { now } = calcVerticalPages();
      const vKey = "bluesongs_reader_vpage_" + lastDocId;
      localStorage.setItem(vKey, String(now));
    } else {
      const max = scroller.scrollHeight - scroller.clientHeight;
      const ratio = max > 0 ? (scroller.scrollTop / max) : 0;
      const posKey = "bluesongs_reader_pos_" + lastDocId;
      localStorage.setItem(posKey, String(clamp(ratio, 0, 1)));
    }
  }, { passive:true });

  // æŠ˜ã‚ŠãŸãŸã¿çŸ¢å°
  controls.addEventListener("toggle", updateOpenHint);

  // init
  loadSettings();
  applyTheme();
  setCssVars();

  encodingSel.value = state.encoding || "shift-jis";
  fontSel.value = state.font || "mincho";

  applyWriting();
  refreshNowReading();
  updateOpenHint();
  updateHudAndScrubber();

  controls.open = false;

  window.addEventListener("resize", () => {
    applyWriting();
    updateHudAndScrubber();
  });

  // åˆæœŸã¯ã‚¹ã‚¯ãƒ©ãƒãƒ¼éè¡¨ç¤º
  hideScrubber();
})();
</script>
</body>
</html>
